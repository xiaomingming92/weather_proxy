# 第二次适配工作清单

## 目标
修复 WeatherTV XML 数据结构，移除填充逻辑，实现策略模式分离 WeatherTV 和 WeatherWidget 处理逻辑。

## 任务清单

### Phase 1: ORM 适配（前置任务）

- [ ] **Task ORM-1**: 更新 Prisma Schema（City 添加站点信息字段）
  - 添加字段：stationId, longitude, latitude, postcode, sunrise, sunset
  - 文件：`prisma/schema.prisma`

- [ ] **Task ORM-2**: 更新 Prisma Schema（WeatherData 添加 appType 和 cacheDuration 字段）
  - 添加字段：appType, cacheDuration
  - 修改索引：@@unique([cityId, dataType, appType])
  - 文件：`prisma/schema.prisma`

- [ ] **Task ORM-3**: 创建 CachePolicy 模型
  - 字段：id, dataType, appType, duration, description, createdAt, updatedAt
  - 文件：`prisma/schema.prisma`

- [ ] **Task ORM-4**: 执行数据库迁移
  - 命令：`npx prisma migrate dev --name add_weathertv_support`
  - 生成 Prisma Client

- [ ] **Task ORM-5**: 更新 TypeScript 类型定义
  - 扩展 DataType 枚举
  - 扩展 WeatherData 接口（添加 stationInfo, advertisement, week 等字段）
  - 文件：`src/types/index.ts`

### Phase 2: 策略模式架构

- [ ] **Task 0**: 设计策略模式架构
  - 创建策略接口：`WeatherDataStrategy`
  - 创建 WeatherTV 策略类：`WeatherTVMainStrategy`, `WeatherTVWidgetSKStrategy`, `WeatherTVWidgetCFStrategy`
  - 创建 WeatherWidget 策略类：`WeatherWidgetCurrentStrategy`, `WeatherWidgetForecastStrategy`
  - 重构 `DataTransform` 类作为上下文/控制器
  - 文件：`src/services/data-transform.ts` 或新建策略文件

### Phase 3: WeatherTV XML 结构修复

- [x] **Task 1**: 修正 SK 节点结构
  - 将 Info 改为 SK 的子节点（当前是同级）
  - 确保 Info 包含所有7个必需属性
  - 生成格式：`<SK ReportTime="..."><Info Weather="..." Temperature="..." WindDir="..." WindPower="..." WindSpeed="..." Humidity="..." Pressure="..." /></SK>`

- [ ] **Task 2**: 修正 CF3h 节点标签
  - 将 `Cf3hPart_TimeScale` 改为 `Period`
  - 生成格式：`<CF3h ReportTime="..."><Period ... /></CF3h>`

- [x] **Task 3**: 修正 ZU 节点结构
  - ~~添加 Period 包装节点~~（错误：WeatherTV 不需要 Period 包装）
  - 修正 ZuType 属性名（Name, Val）
  - 始终生成 ZU 节点（使用默认数据避免 FC）
  - 生成格式：`<ZU ReportTime="..."><Type Name="..." Val="...">...</Type>...</ZU>`

- [ ] **Task 4**: 添加 StationInfo 节点生成
  - 字段：Stationid, Longitude, Latitude, Postcode, Sunrise, Sunset
  - 生成格式：`<StationInfo Stationid="..." Longitude="..." ... />`

- [ ] **Task 5**: 添加 AdvFile 节点生成
  - 生成格式：`<AdvFile><Adv Type="CF" Flag="..." />...</AdvFile>`

- [ ] **Task 6**: 为 CF Period 添加 Week 属性
  - 根据日期计算星期（1-7）

- [ ] **Task 7**: 移除所有长度填充逻辑
  - 删除 `addLengthPadding` 方法
  - 删除 `addZteLengthPadding` 方法
  - 删除所有调用填充方法的代码

- [ ] **Task 11**: 验证生成的 XML 长度超过 1500 字符
  - 通过生成完整数据结构自然满足长度要求
  - 参考 `newdata.xml`（2107 字符）

### Phase 4: 新增接口支持

- [ ] **Task 8**: 新增 WidgetSK 格式生成方法（dataType=ztewidgetsk）
  - 简化格式：CityMeteor > SK > Info

- [ ] **Task 9**: 新增 WidgetCF 格式生成方法（dataType=ztewidgetcf）
  - 简化格式：CityMeteor > CF > Period

- [ ] **Task 10**: 新增城市列表格式生成方法（flag=allcity）
  - 格式：CityList > Province > District

## 参考文档

1. **WeatherTV XML 解析组件完整分析**: `.trae/documents/v2/WeatherTV_V880+ XML 解析组件完整分析.md`
2. **ORM 适配计划**: `.trae/documents/v2/ORM适配.md`
3. **示例 XML**: `WeatherTV_V880+/res/raw/newdata.xml`（2107 字符）

## 关键要求

1. **1500 字符最小长度**: WeatherTV 硬性要求，通过完整数据结构自然满足
2. **策略模式**: 分离 WeatherTV 和 WeatherWidget 处理逻辑
3. **向后兼容**: 新字段设置为可选（nullable）
4. **真实数据**: 不使用空格填充，提供完整真实数据结构

## 开始时间

2026-02-12

## 预计完成

待定
